{
	"version": "https://jsonfeed.org/version/1.1",
	"title": "Adrien",
	"language": "en",
	"home_page_url": "https://www.dipasquale.fr/eleventy-base-blog/",
	"feed_url": "https://www.dipasquale.fr/eleventy-base-blog/feed/feed.json",
	"description": "Adrien Di Paquale personal website",
	"author": {
		"name": "Adrien Di Pasquale",
		"url": ""
	},
	"items": [
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/",
			"title": "Scraping tips",
			"content_html": "<p>Scraping websites can sometimes get tricky, but that's when things gets interesting.\nWhen you're aiming to scrape data from a website that doesn't want to be scraped, it becomes like a game of cat and mouse.</p>\n<p><img src=\"https://i.imgur.com/HwN6qYV.jpg\" alt=\"\"></p>\n<p>The website tries to identify robots and prevent them from accessing the data, without impacting actual users browsing the website.\nThe robots are thus designed to mimick as closely as possible actual users' behaviour, so as to become stealth.</p>\n<p>Here is a list of recommendations, more or less obvious, but always useful to remind of.</p>\n<h2 id=\"keep-it-simple-stupid\" tabindex=\"-1\">Keep It Simple, Stupid <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>Websites have become complex with Single Page Applications and React, Vue...\nDo not forget that browsing websites comes down to HTTP requests being sent to servers.</p>\n<p>There are two approaches to scraping:</p>\n<ol>\n<li>reproduce individual HTTP requests one by one</li>\n<li>mimick an actual browser and user clicking around</li>\n</ol>\n<p>üíÅüèΩ‚Äç‚ôÄÔ∏è As often as you can, try to use the first method. It is usually much more reliable and efficient.</p>\n<p>However, the two approaches are complimentary.\nSometimes the second one is necessary, if the interactions between the JS and the HTTP requests are too entangled.</p>\n<h2 id=\"sniff-out-apis\" tabindex=\"-1\">Sniff out APIs <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>Look for public APIs that return JSON instead of HTML that you have to parse.\nUse your browser's network tab XHR filter to do so.\nThis is often the case with Single Page Applications.</p>\n<p><img src=\"https://i.imgur.com/i6erv0B.gif\" alt=\"Product Hunt GraphQL API\"></p>\n<p>Mobile applications also often use an API to collect data from the servers.\nMost of the time this API will be somehow authenticated, but it is sometimes very easy to find a working token.</p>\n<p>‚öôÔ∏è Use <a href=\"https://www.charlesproxy.com/\">Charles Proxy</a> to listen to outgoing requests from mobile applications.</p>\n<h2 id=\"know-your-http-basics\" tabindex=\"-1\">Know your HTTP basics <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>HTTP requests have 4 simple characteristics:</p>\n<ol>\n<li>An URL (with optional query string params)</li>\n<li>A verb (aka a method, eg: GET, POST, etc)</li>\n<li>Optional Headers</li>\n<li>An optional body (for non-GET requests)</li>\n</ol>\n<p>The body can be any type of text or binary data, which should be described by the <code>Content-Type</code> header.\nYou can find every valid value <a href=\"http://www.iana.org/assignments/media-types/media-types.xhtml\">here</a></p>\n<p>üí° When you get stuck and cannot figure out how the website can block your request, compare these 4 characteristics to an actual request from your browser.</p>\n<p>üîí Also, prefer HTTPs requests, websites can get suspicious otherwise.</p>\n<h2 id=\"don-t-reinvent-the-wheel\" tabindex=\"-1\">Don't reinvent the wheel <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>I strongly recommend against using a regular HTTP library (e.g. Python's <a href=\"https://requests.readthedocs.io/\"><code>requests</code></a> or Ruby's <a href=\"https://github.com/httprb/http\"><code>http</code></a>) .\nInstead, build upon a scraping framework like Python's <a href=\"https://github.com/scrapy/scrapy\"><code>Scrapy</code></a>, NodeJS <a href=\"https://github.com/yujiosaka/headless-chrome-crawler\"><code>headless-chrome-scraper</code></a> or Go's <a href=\"https://github.com/gocolly/colly\">Colly</a>.</p>\n<p>You won't have to reimplement super common patterns, like requests throttling, retries policy, links traversal and deduplication, passing cookies...\nAs a web framework does for building websites, this will help you focus on the core specific code that targets your websites.</p>\n<p>üôå <a href=\"https://github.com/scrapy/scrapy\"><code>Scrapy</code></a> is my personal favourite. It is open source with a backing company <a href=\"https://scrapinghub.com/scrapy-cloud\">ScrapingHub</a> that also provides a Heroku-like PaaS service. I'm not affiliated to them in any way, but they provide instant deployment and scheduling, with an extremely low pricing policy (it's often free).</p>\n<h2 id=\"become-a-curl-ninja\" tabindex=\"-1\">Become a curl Ninja <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>You may be tempted to use GUIs like <a href=\"https://www.getpostman.com/\">Postman</a> or <a href=\"https://insomnia.rest/\">Insomnia</a>, but I would suggest you get to learn <code>curl</code> instead.\nIt is actually not very complicated and lets you do everything without restrictions.\nYou can then reproduce it in any SSH terminal.\n<code>man curl</code> is your friend.</p>\n<p>Use and abuse the &quot;Copy as curl&quot; feature in your network tab, to paste it in a terminal and see if it's reproductible.\nWhat I often do is try and find the smallest set of headers and body params that still succeds by bissecting down.</p>\n<p><em>Pro Tip</em>: copied curl commands can be lengthy.\nI often copy them in my IDE, search and replace all <code>-H</code> with <code>-H \\n</code> (with regex mode activated) to get one line per header.</p>\n<p>‚öôÔ∏è <a href=\"https://curl.trillworks.com/\">Python to curl</a> is a tool that converts curl commands to Python <code>requests</code> call.</p>\n<h2 id=\"best-practices-for-scrapers\" tabindex=\"-1\">Best practices for scrapers <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<ul>\n<li>Fetch first, store the response and then parse it. This way you won't have to refetch if there is a bug in your parser.</li>\n<li>You can also use caching locally when developping to bypass this problem</li>\n<li>Distribute the workload in successive steps. eg. for a cooking website, first retrieve all recipes URLs and then fetch them instead of directly following every nested link.</li>\n</ul>\n<h2 id=\"it-works-on-my-computer\" tabindex=\"-1\">It works on my computer‚Ñ¢Ô∏è <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>As often, the scraper you wrote may work locally but not in production.</p>\n<p>One source of issues is the IP of your server that may be blacklisted.\nIt is easy for the defending websites to block whole range of IPs that are known to come from datacenters, or to whitelist specific countries IPs.\nThe usual counter for this is to use proxies.\nYou will find countless services that sell proxies access on the internet, with varying quality.\nSometimes you won't have a choice but to use residential proxies that are costy (&gt;100USD/mo.).</p>\n<p>‚öôÔ∏è <a href=\"https://icanhazip.com/\">icanhazip</a> is a simpleway to check the IP you're currently scraping from.</p>\n<p>Another source of trouble is the classical environment differences that you forgot about.\nFor example, you may generate timestamps in your code and format them to forge requests, and the timezone may be different on your machine and on the production server.</p>\n<p>‚öôÔ∏è <a href=\"https://httpbin.org/\">httpbin</a> can be useful to double check that the received data by the distant server is actually what you meant to send.</p>\n<h2 id=\"have-fun\" tabindex=\"-1\">Have fun! <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-12-10-scraping-tips/\">#</a></h2>\n<p>Figuring out how to bypass another developer's protections can be a really fun puzzle to solve.</p>\n<p>ü§úü§õ Be a good citizen and scrape responsibly:</p>\n<ul>\n<li>Space out requests so they don't overflow the website.</li>\n<li>Only scrape public data</li>\n<li>If you encounter private or sensitive data that should not be public, warn the website.</li>\n</ul>\n<p><em>Written by <a href=\"https://github.com/maelorn\">Isma√´l Attoumani</a> and <a href=\"https://twitter.com/hypertextadrien/\">Adrien Di Pasquale</a>, proofread by <a href=\"https://twitter.com/AntoineAugusti\">Antoine Augusti</a></em></p>\n",
			"date_published": "2019-12-10T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/",
			"title": "Combining React Router and Shopify App Bridge Navigation",
			"content_html": "<p>In this article we will show you a quick way to navigate correctly inside your react embedded app using shopify app-bridge and polaris libraries.</p>\n<h2 id=\"linking-links\" tabindex=\"-1\">Linking links <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/\">#</a></h2>\n<p>The first thing to do is to link the react router <code>Link</code>  component with shopify polaris <code>Link</code>. To do so, we pass an Adapter to our <code>AppProvider</code> component. Shopify anticipated this issue so you only have to pass the Adapter to the <code>AppProvider</code> component under the attribute <code>linkComponent</code>. Here is an example :</p>\n<pre class=\"language-jsx\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Link <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AppProvider <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@shopify/polaris'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">AdapterLink</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> url<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Link</span></span> <span class=\"token attr-name\">to</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>url<span class=\"token punctuation\">}</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>rest<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token punctuation\">}</span>\n\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AppProvider</span></span>\n    <span class=\"token attr-name\">apiKey</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>apiKey<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">shopOrigin</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>shopOrigin<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">linkComponent</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>AdapterLink<span class=\"token punctuation\">}</span></span>\n  <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  ...\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AppProvider</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code></pre>\n<h2 id=\"a-history-of-wrap\" tabindex=\"-1\">A history of wrap <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/\">#</a></h2>\n<p><a href=\"https://help.shopify.com/en/api/embedded-apps/app-bridge/actions/navigation/history\">Here is how to use the app bridge history object to navigate inside your app.</a></p>\n<p>Now what we want is to provide to the history the url given to our <code>Route</code> component.</p>\n<h3 id=\"accessing-the-history-object\" tabindex=\"-1\">Accessing the history object <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/\">#</a></h3>\n<p>The doc does not tell us how to access the history from inside a react component. But it is actually possible to access it via <a href=\"https://reactjs.org/docs/context.html\">React contexts</a> if your component is between two <code>AppProvider</code> components by adding this :</p>\n<pre class=\"language-jsx\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token keyword\">static</span> contextTypes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">polaris</span><span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>object\n<span class=\"token punctuation\">}</span></code></pre>\n<p>now you can call the <code>appBridge</code> inside your class, like for example in the constuctor :</p>\n<pre class=\"language-jsx\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token punctuation\">,</span>context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>polaris<span class=\"token punctuation\">.</span>appBridge\n<span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"wrapper\" tabindex=\"-1\">Wrapper <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/\">#</a></h3>\n<p>To combine both things we have to push the url of the <code>Route</code> inside the polaris history. So what we did is creating a wrapped component that does that every time he receives a new url :</p>\n<pre class=\"language-jsx\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> History <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@shopify/app-bridge/actions'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Route <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-dom'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">withShopifyEmbeddedAppPushState</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">WrappedComponent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">extends</span> React<span class=\"token punctuation\">.</span>Component <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> contextTypes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">polaris</span><span class=\"token operator\">:</span> PropTypes<span class=\"token punctuation\">.</span>object\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">componentWillReceiveProps</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">nextProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>polaris<span class=\"token punctuation\">.</span>appBridge\n      <span class=\"token keyword\">const</span> history <span class=\"token operator\">=</span> History<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n      history<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>History<span class=\"token punctuation\">.</span>Action<span class=\"token punctuation\">.</span><span class=\"token constant\">PUSH</span><span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">.</span>computedMatch<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">render</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">WrappedComponent</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ShopifyEmbeddedAppRoute <span class=\"token operator\">=</span> <span class=\"token function\">withShopifyEmbeddedAppPushState</span><span class=\"token punctuation\">(</span>Route<span class=\"token punctuation\">)</span></code></pre>\n<h2 id=\"et-voila\" tabindex=\"-1\">Et voil√† ! <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2019-02-28-polaris-react-router/\">#</a></h2>\n<p>Here is what your rendering should like now :</p>\n<pre class=\"language-jsx\" tabindex=\"0\"><code class=\"language-jsx\">ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AppProvider</span></span>\n     <span class=\"token attr-name\">apiKey</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>apiKey<span class=\"token punctuation\">}</span></span>\n     <span class=\"token attr-name\">shopOrigin</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>shopOrigin<span class=\"token punctuation\">}</span></span>\n     <span class=\"token attr-name\">linkComponent</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>AdapterLink<span class=\"token punctuation\">}</span></span>\n   <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n     </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BrowserRouter</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n       </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Switch</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n           </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ShopifyEmbeddedAppRoute</span></span>\n             <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>/products<span class=\"token punctuation\">'</span></span>\n             <span class=\"token attr-name\">render</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">p</span> <span class=\"token operator\">=></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ProductsContainer</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>p<span class=\"token punctuation\">}</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span></span>\n           <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Switch</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n       </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n     </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">BrowserRouter</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n   </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AppProvider</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code></pre>\n<p>Now if you place links inside your react app :</p>\n<pre class=\"language-jsx\" tabindex=\"0\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Link <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@shopify/polaris'</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Link</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>/products<span class=\"token punctuation\">'</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Subscription Products</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Link</span></span><span class=\"token punctuation\">></span></span></code></pre>\n<p>it will call our wrapped component that will push the correct url inside shopify history !\nYou are now in the right page with the correct url üï∫</p>\n",
			"date_published": "2019-02-28T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/",
			"title": "Build and deploy huge static websites with Caddy",
			"content_html": "<p>I will show you how to setup the hosting and deployment of a static website with thousands of pages dynamically built. It uses the <a href=\"https://caddyserver.com/\">Caddy web server</a> and a <a href=\"https://digitalocean.com/\">Digital Ocean</a>'s droplet - but it would work with any Ubuntu server.</p>\n<h1 id=\"introduction\" tabindex=\"-1\">Introduction <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h1>\n<h2 id=\"first-of-all-don-t-do-it\" tabindex=\"-1\">First of all, don't do it! <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h2>\n<p>There are very few cases where it makes sense to use such a setup.\n<a href=\"https://www.netlify.com/\">Netlify</a>, among others, is a great hosting provider for static websites.\nIt is way simpler to setup, it can run custom build scripts, it gives you HTTPS out of the box, and CDN delivery.\nAll that for free!\nSo really, try building your website there first.</p>\n<p>In some cases though, you may reach Netlify's limits.\nI personally experienced failures on Netlify upon deploying a website with 20k+ pages.\nEven though the build part takes 2 minutes or so, deploys would hang on the upload step.</p>\n<h2 id=\"why-not-host-it-on-s3\" tabindex=\"-1\">Why not host it on S3 ? <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h2>\n<p>The next reasonable option would be to host the static website on S3.\nIt's a pretty common setup too and is well documented by AWS.</p>\n<p>Because builds should be automated, I tried setting up an AWS Lambda function that runs the build and uploads the files to S3.\nAfter 2 days of headaches fighting with the AWS docs to understand how to make it work, I managed to finally run it.\nOnly to find out that the upload process from the AWS Lambda local storage to S3 is not fast enough.</p>\n<p>I tried parallelizing the uploads using threads, but it was still too slow.\nI managed to get to about 500 pages/minute but the Lambdas have a maximum timeout of 15 minutes so it's not enough.\nIn any cases, a build that takes more than 15 minutes would not have been satisfying.</p>\n<p>I'm not an AWS expert, but the whole process was so frustrating that I decided to go old-school and host it on a server I control.</p>\n<h1 id=\"server-setup\" tabindex=\"-1\">Server setup <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h1>\n<p>I chose to use <a href=\"https://www.digitalocean.com/\">Digital Ocean (aka DO)</a> for hosting my server, but most of these instructions would be applicable to any other provider (<a href=\"https://www.scaleway.com//\">Scaleway</a>, <a href=\"https://www.vultr.com/\">Vultr</a>, <a href=\"https://www.exoscale.com\">Exoscale</a> ...).</p>\n<p>DO has a great blog about <a href=\"https://blog.digitalocean.com/deploying-a-fully-automated-git-based-static-website-in-under-5-minutes/\">Deploying a Fully-automated Git-based Static Website in Under 5 Minutes</a> which helped me a lot.\nI have condensed the instructions into a shell script: <a href=\"https://gist.github.com/adipasquale/05e432157fcba07b0d2a8cbfdf326670\">https://gist.github.com/adipasquale/05e432157fcba07b0d2a8cbfdf326670</a>.\nIf you're not familiar with this kind of setup, I suggest you follow the blog post instead of running the script.</p>\n<p>In order to run the script, SSH into the newly created server and:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">wget</span> <span class=\"token parameter variable\">-O</span> - https://gist.github.com/adipasquale/05e432157fcba07b0d2a8cbfdf326670/raw <span class=\"token operator\">|</span> <span class=\"token function\">sh</span></code></pre>\n<p>Here is a quick summary of this script:</p>\n<ul>\n<li>It installs the Caddy server</li>\n<li>It creates a systemd service</li>\n<li>It sets up Caddy to listen to a subdomain of nip.io</li>\n<li>Caddy will use Let's Encrypt to get you a valid SSL certificate so that HTTPS works out-of-the-box.</li>\n<li>It uses the Caddy git plugin to automatically stay in sync with this repo: <a href=\"https://github.com/kamaln7/basic-static-website\">kamaln7/basic-static-website</a></li>\n</ul>\n<p>The last output should point you to an URL that looks like https://YOUR_SERVER_IP.nip.io:</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/IsPIwBrsgR-2046.avif 2046w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/IsPIwBrsgR-2046.webp 2046w\"><img alt=\"basic static website\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/IsPIwBrsgR-2046.png\" width=\"2046\" height=\"1324\"></picture></p>\n<p><em>(notice the green lock :)</em></p>\n<p>In case it does not work properly, you can run this command on the server to see logs and exceptions from Caddy:</p>\n<pre><code>tail -f /var/log/syslog\n</code></pre>\n<p><strong>Important Note</strong>: We are skipping a lot of important steps for an actual production server here:</p>\n<ul>\n<li>You should follow <a href=\"https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04\">this DO guide</a> for securing your Ubuntu droplet</li>\n<li>You should create a DO Firewall <a href=\"https://cloud.digitalocean.com/networking/firewalls\">here</a> and allow SSH, HTTP, and HTTPS inbound traffic</li>\n<li>If you own a domain name, you can add an DNS record of the A type that points to your droplet's IP, or follow <a href=\"https://www.digitalocean.com/docs/networking/dns/how-to/add-domains/\">this short guide</a> to use DO's own name servers. Here, we are using nip.io to have a subdomain without any setup.</li>\n</ul>\n<h1 id=\"dynamic-build-system\" tabindex=\"-1\">Dynamic build system <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h1>\n<p>Currently, the server is synchronizing with a very simple static website project, that has no build script at all.</p>\n<p>We will now switch to a dynamic build system.\nThe build script will create HTML pages from external data and template files, and the server will now serve the resulting files.\nThis build script will be re-executed upon each git push to the repository.</p>\n<p>For the purpose of this article, I have created a very simple static website builder: <a href=\"https://github.com/adipasquale/giantsite\">giantsite</a>.\nIt's a 50-lines Python 3 script, that queries a <a href=\"https://jsonplaceholder.typicode.com/\">dummy API</a> for 5000 photos, builds an HTML page for each and an index page that links to them.</p>\n<p>First, fork <a href=\"https://github.com/adipasquale/giantsite\">giantsite</a>.</p>\n<p>Now let's update Caddy's configuration.\nSSH into the server and update it with <code>vim /etc/caddy/Caddyfile</code>:</p>\n<pre><code># /etc/caddy/Caddyfile\n\nhttps://YOUR_SERVER_IP.nip.io {\n    [...]\n    git https://github.com/YOUR_GITHUB_HANDLE/giantsite /var/code/giantsite {\n        interval 300\n        then python3 /var/code/giantsite/build.py /var/www\n    }\n    root /var/www\n}\n</code></pre>\n<p><em>(don't forget to replace the CAPITAL_PARTS with your infos)</em></p>\n<p>Here is what we have changed:</p>\n<ul>\n<li>We have switched the GitHub repository from the static one to the dynamically built one that you just forked.</li>\n<li>We have also specified where the local repository should be stored: <code>/var/code/giantsite</code></li>\n<li>We have added a call to the <code>build.py</code> script from the fetched repo in the <code>then</code> option.\nIt will be ran upon each new pull.</li>\n<li>Finally, we have declared that the server's root is <code>/var/www</code>.\nIt defines the files that will be served.</li>\n</ul>\n<p>We still have to perform a few steps in order for this setup to work.\nAgain, ssh into the server and run these commands</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token comment\"># Install python3 (it's already installed on DO's droplets)</span>\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> python3\n\n<span class=\"token comment\"># Create the new folders and set correct permissions</span>\n<span class=\"token function\">mkdir</span> /var/code/\n<span class=\"token function\">mkdir</span> /var/www/\n<span class=\"token function\">chown</span> www-data:www-data /var/code/\n<span class=\"token function\">chown</span> www-data:www-data /var/www/\n\n<span class=\"token comment\"># Restart Caddy, this will trigger a re-build</span>\nsystemctl restart caddy</code></pre>\n<p><em>Note : You may have to use <code>sudo</code> here if you're not logged in as root</em></p>\n<p>You should now be able to access your website and see the newly built website :</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/6UM0nCpHBC-718.avif 718w\"><source type=\"image/gif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/6UM0nCpHBC-718.gif 718w\"><img alt=\"giantsite screencast\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/6UM0nCpHBC-718.webp\" width=\"718\" height=\"465\"></picture></p>\n<h2 id=\"auto-deploys-on-push\" tabindex=\"-1\">Auto-deploys on push <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h2>\n<p>Currently, our Caddy server will synchronize with the GitHub repository every 300 seconds or so.\nLet's setup a Webhook from GitHub to our server, so that it synchronizes and rebuilds upon each push.</p>\n<p>First, open a terminal and copy the output from <code>uuidgen</code>.\nWe'll use this random string as a shared secret in our Webhook.</p>\n<p>Now let's setup Caddy so it listens to the Webhook.\nSSH into the server, and run <code>vim /etc/caddy/Caddyfile</code> :</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token comment\"># /etc/caddy/Caddyfile</span>\n\nhttps://YOUR_SERVER_IP.nip.io <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span>\n    <span class=\"token function\">git</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span>\n        hook /github_hook YOUR_WEBHOOK_SECRET\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>and again, restart Caddy with :</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">systemctl restart caddy</code></pre>\n<p>The last step is to go to your forked GitHub repository's Settings, and click &quot;Add Webhook&quot; in the Webhooks tab. Use <code>https://YOUR_SERVER_IP.nip.io/github_webhook</code> for the url. I suggest using a JSON Webhook, I've had issues with the regular ones</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/0pu8wGHx-U-2020.avif 2020w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/0pu8wGHx-U-2020.webp 2020w\"><img alt=\"Create a GitHub Webhook\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/0pu8wGHx-U-2020.png\" width=\"2020\" height=\"998\"></picture>.</p>\n<p>You can now try making a small change to the <code>build.py</code> script and pushing it.\nYour Caddy server should pick it up within a few seconds, and rebuild the pages accordingly.</p>\n<h1 id=\"bonus-api-to-manually-trigger-re-builds\" tabindex=\"-1\">Bonus: API to manually trigger re-builds <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h1>\n<p>If your external data is updated, you may want to trigger a build even though the code has not changed.\nIt can therefore be useful to have another Webhook that triggers rebuilds and is not linked to GitHub.</p>\n<p>Let's setup a small server that listens to GET requests on <code>/admin/rebuild</code> and triggers builds.\nI'm using <a href=\"https://bottlepy.org/docs/dev/\">bottle</a> here, as it's the simplest one I can think of, but feel free to use any framework you like.</p>\n<p>Create a new <code>server.py</code> file at the root of your forked repository :</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># server.py</span>\n\n<span class=\"token keyword\">from</span> build <span class=\"token keyword\">import</span> Builder\n<span class=\"token keyword\">from</span> bottle <span class=\"token keyword\">import</span> route<span class=\"token punctuation\">,</span> run\n\n\n<span class=\"token decorator annotation punctuation\">@route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/admin/rebuild'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">rebuild</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    Builder<span class=\"token punctuation\">(</span><span class=\"token string\">\"/var/www\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">'Rebuild done !'</span>\n\nrun<span class=\"token punctuation\">(</span>host<span class=\"token operator\">=</span><span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> debug<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></code></pre>\n<p>Commit it and push it so that your server picks it up.</p>\n<p>Now, SSH into your server and install bottle:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">apt</span> update\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> python3-pip\npip3 <span class=\"token function\">install</span> bottle</code></pre>\n<p>You need to create another systemd service for this bottle server:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token comment\"># /etc/systemd/system/bottle.service</span>\n\n<span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Bottle server\n<span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>syslog.target\n\n<span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>simple\n<span class=\"token assign-left variable\">User</span><span class=\"token operator\">=</span>www-data\n<span class=\"token assign-left variable\">Group</span><span class=\"token operator\">=</span>www-data\n<span class=\"token assign-left variable\">WorkingDirectory</span><span class=\"token operator\">=</span>/var/code/giantsite\n<span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/bin/env python3 server.py\n<span class=\"token assign-left variable\">StandardOutput</span><span class=\"token operator\">=</span>syslog\n<span class=\"token assign-left variable\">StandardError</span><span class=\"token operator\">=</span>syslog\n<span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always\n<span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>\n\n<span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>bottle.target</code></pre>\n<p>This new service can be started with:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">systemctl start bottle\nsystemctl <span class=\"token builtin class-name\">enable</span> bottle</code></pre>\n<p>And we also have to update the Caddyfile so that external requests are directed to this bottle server:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token comment\"># /etc/caddy/Caddyfile</span>\n\nhttps://YOUR_SERVER_IP.nip.io <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span>\n    proxy /admin localhost:8000 <span class=\"token punctuation\">{</span>\n        transparent\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><em>Note: I used a namespaced route <code>/admin</code> here but you're free to do as you please. Be careful that it matches what bottle expects though.</em></p>\n<p>Finally, restart Caddy so that the changes are applied:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">systemctl restart caddy</code></pre>\n<p>Phew! You should now be able to trigger a rebuild with a simple:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">curl</span> https://YOUR_SERVER_IP.nip.io/admin/rebuild</code></pre>\n<p>üõ† Build, Build, Build üõ†</p>\n<h1 id=\"conclusion\" tabindex=\"-1\">Conclusion <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-27-build-and-deploy-huge-static-websites-with-caddy/\">#</a></h1>\n<p>This setup makes sense only in rare situations, namely when you are building thousands of files.\nIt's an interesting experience though, as it shows how easy and convenient Caddy makes it.\nThe <a href=\"https://caddyserver.com/docs/http.git\">git plugin</a> is particularly cool, it's so nice to be able to deploy with a simple <code>git push</code>.</p>\n<p>This setup is not ready for production, make sure to add some security measures! The rebuild API is completely unprotected for instance.</p>\n<p>Let me know what you think!</p>\n<p><a href=\"https://news.ycombinator.com/item?id=18768691\">Discuss on Hacker News</a></p>\n",
			"date_published": "2018-12-27T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/",
			"title": "Incremental crawler with Scrapy and MongoDB",
			"content_html": "<ul>\n<li>updated on 25/12/2018 : <a href=\"https://github.com/adipasquale/blog.dipasquale.fr/commit/8d2b191e1a1a7151c6b01b088d9c98812376aec1\"><em>fixed from_crawler method overriding</em></a></li>\n</ul>\n<p>In this post I will show you how to scrape a website incrementally.\nEach new scraping session will only scrape new items.\nWe will be crawling <a href=\"https://techcrunch.com/\">Techcrunch blog posts</a> as an example here.</p>\n<p>This tutorial will use Scrapy, a great Python scraping library.\nIt's simple yet very powerful.\nIf you don't know it, have a look at their <a href=\"https://doc.scrapy.org/en/latest/intro/overview.html\">overview page</a>.</p>\n<p>We will also use MongoDB, the famous NoSQL DB, but it would be a similar process with any DB you want.</p>\n<p><strong>TLDR;</strong> if you already know Scrapy, head to the <a href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">last part about incremental scraping</a>. You can find the full code for this project <a href=\"https://github.com/adipasquale/techcrunch-incremental-scrapy-spider-with-mongodb\">here on GitHub</a>.</p>\n<h1 id=\"setup-your-scrapy-spider\" tabindex=\"-1\">Setup your Scrapy spider <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h1>\n<p>Start by installing Scrapy</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">pip3 <span class=\"token function\">install</span> scrapy</code></pre>\n<p><em>(in a real project, you would use a <a href=\"https://virtualenv.pypa.io/en/latest/\">virtualenv</a> and a <code>requirements.txt</code> file)</em></p>\n<p>and initialize your project with:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">scrapy startproject tc_scraper\n<span class=\"token builtin class-name\">cd</span> tc_scraper\nscrapy genspider techcrunch techcrunch.com</code></pre>\n<h1 id=\"scrape-the-posts\" tabindex=\"-1\">Scrape the posts <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h1>\n<h2 id=\"play-around-in-the-shell\" tabindex=\"-1\">Play around in the shell <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>First have a look at the DOM structure on <a href=\"https://www.techcrunch.com\">https://www.techcrunch.com</a>, using your browser's developer tools.</p>\n<p><strong>Make sure to disable Javascript</strong>, because the scraper will not execute it by default.\nIt's doable with Scrapy, but it's not the point of this tutorial.\nI'm using <a href=\"https://addons.mozilla.org/en-US/firefox/addon/javascript-toggler/\">this extension</a> to easily disable JS on Firefox.</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/K1lq4zmGWW-1297.avif 1297w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/K1lq4zmGWW-1297.webp 1297w\"><img alt=\"inspection of Techcrunch's DOM in Firefox\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/K1lq4zmGWW-1297.png\" width=\"1297\" height=\"989\"></picture></p>\n<p>You can then open a Scrapy shell with</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">scrapy shell https://www.techcrunch.com</code></pre>\n<p>This shell is very helpful to play around and figure out how to extract the data. Here are some commands you can try one by one:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\">response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block\"</span><span class=\"token punctuation\">)</span>\nposts <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block\"</span><span class=\"token punctuation\">)</span>\nposts<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\nposts<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block__title__link\"</span><span class=\"token punctuation\">)</span>\ntitle <span class=\"token operator\">=</span> posts<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block__title__link\"</span><span class=\"token punctuation\">)</span>\ntitle\ntitle<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"::attr(href)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntitle<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"::attr(href)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>We are using CSS selectors, and the <code>attr</code> function on CSS3 pseudo-elements.\nLearn more about this extraction part in the <a href=\"https://doc.scrapy.org/en/latest/topics/selectors.html\">scrapy docs</a>.</p>\n<h2 id=\"scrapy-architecture\" tabindex=\"-1\">Scrapy architecture <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/M8E8zmMYaF-700.avif 700w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/M8E8zmMYaF-700.webp 700w\"><img alt=\"scrapy architecture\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/M8E8zmMYaF-700.png\" width=\"700\" height=\"494\"></picture></p>\n<p>This diagram  from <a href=\"https://doc.scrapy.org/en/0.10.3/topics/architecture.html\">scrapy docs</a> is a quick overview of how Scrapy works:</p>\n<ul>\n<li>The <span style=\"color:#DC2300;\">Spider</span> yields <span style=\"color:#8AAF59\">Requests</span>, which are sent to the <span style=\"color:#CCCCFF\">Scheduler</span>.</li>\n<li>The <span style=\"color:#CCCCFF\">Scheduler</span> sends <span style=\"color:#8AAF59\">Requests</span> to the <span style=\"color:#E6E64C\">Downloader</span>, which executes them against the distant website.</li>\n<li>The <span style=\"color:#8AAF59\">Responses</span> are sent to the <span style=\"color:#DC2300;\">Spider</span> for parsing.</li>\n<li>The <span style=\"color:#DC2300;\">Spider</span> parses and yields Items, which are sent to the <span style=\"color:#FF9966\">Item Pipeline</span>.</li>\n<li>The <span style=\"color:#FF9966\">Item Pipeline</span> is responsible for processing them and storing them.</li>\n</ul>\n<p>In this tutorial, we will not touch the <span style=\"color:#CCCCFF\">Scheduler</span>, nor the <span style=\"color:#E6E64C\">Downloader</span>.</p>\n<p>We will only write a <span style=\"color:#DC2300;\">Spider</span> and tweak the <span style=\"color:#FF9966\">Item Pipeline</span>.</p>\n<h2 id=\"scrape-the-list-pages\" tabindex=\"-1\">Scrape the list pages <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>So let's write the first part of the scraper:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># spiders/techcrunch.py</span>\n\n<span class=\"token keyword\">import</span> scrapy\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TechcrunchSpider</span><span class=\"token punctuation\">(</span>scrapy<span class=\"token punctuation\">.</span>Spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    name <span class=\"token operator\">=</span> <span class=\"token string\">'techcrunch'</span>\n    allowed_domains <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'techcrunch.com'</span><span class=\"token punctuation\">]</span>\n    start_urls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'https://techcrunch.com/'</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> post <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            title <span class=\"token operator\">=</span> post<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block__title__link\"</span><span class=\"token punctuation\">)</span>\n            url <span class=\"token operator\">=</span> title<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"::attr(href)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">yield</span> scrapy<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>parse_post<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".load-more\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            next_page_url <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".load-more::attr(href)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">yield</span> scrapy<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">(</span>next_page_url<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">parse_post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span></code></pre>\n<p>Here is a walkthrough of this spider:</p>\n<ul>\n<li>It starts by scraping the start url https://techcrunch.com/</li>\n<li>It goes through all posts blocks, extracts the link, and enqueues a new request.\nThis new request will use a different callback from the default one: <code>parse_post</code></li>\n<li>After going through all the posts, it looks for a next page link, and if it finds it, it enqueues a new request with that link.\nThis request will use the default callback <code>parse</code></li>\n</ul>\n<p>You can run it with <code>scrapy crawl techcrunch</code>, but be aware that it will go through ALL the pages (thousands here), so be ready to hit <code>CTRL+C</code> to stop it!</p>\n<h2 id=\"add-a-pages-limit-argument\" tabindex=\"-1\">Add a pages limit argument <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>In order to avoid this problem, let's add a pages limit argument to our spider right now:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># spiders/techcrunch.py</span>\n\n<span class=\"token keyword\">import</span> scrapy\n<span class=\"token keyword\">import</span> re\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TechcrunchSpider</span><span class=\"token punctuation\">(</span>scrapy<span class=\"token punctuation\">.</span>Spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ...</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> limit_pages<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>TechcrunchSpider<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> limit_pages <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>limit_pages <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>limit_pages<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>limit_pages <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># ...</span>\n        <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".load-more\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            next_page_url <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".load-more::attr(href)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\"># urls look like https://techcrunch.com/page/4/</span>\n            <span class=\"token keyword\">match</span> <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token keyword\">match</span><span class=\"token punctuation\">(</span><span class=\"token string\">r\".*\\/page\\/(\\d+)\\/\"</span><span class=\"token punctuation\">,</span> next_page_url<span class=\"token punctuation\">)</span>\n            next_page_number <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">match</span><span class=\"token punctuation\">.</span>groups<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> next_page_number <span class=\"token operator\">&lt;=</span> self<span class=\"token punctuation\">.</span>limit_pages<span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">yield</span> scrapy<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">(</span>next_page_url<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># ...</span></code></pre>\n<p>In the constructor, we allow passing a new kwarg called limit_pages, which we cast to an integer.\nIn the <code>parse</code> method, we extract the next page number thanks to a regex on the url. Then we compare it to the <code>limit_pages</code> argument, and only if it's below, we enqueue the next page request.</p>\n<p>You can now run the spider safely with:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">scrapy crawl techcrunch <span class=\"token parameter variable\">-a</span> <span class=\"token assign-left variable\">limit_pages</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></code></pre>\n<h2 id=\"scrape-the-post-pages\" tabindex=\"-1\">Scrape the post pages <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>So far, we have left the <code>scrape_post</code> request empty, so our spider is not actually scraping anything.\nHere is what post pages look like (again, without JS):</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/Bynikwn-dI-789.avif 789w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/Bynikwn-dI-789.webp 789w\"><img alt=\"a Techcrunch post page\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/Bynikwn-dI-789.png\" width=\"789\" height=\"948\"></picture></p>\n<p>Before writing the scraper method, we need to declare the items that we are going to scrape:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># items.py</span>\n<span class=\"token keyword\">import</span> scrapy\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BlogPost</span><span class=\"token punctuation\">(</span>scrapy<span class=\"token punctuation\">.</span>Item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    url <span class=\"token operator\">=</span> scrapy<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    title <span class=\"token operator\">=</span> scrapy<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    author <span class=\"token operator\">=</span> scrapy<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    content <span class=\"token operator\">=</span> scrapy<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    published_at <span class=\"token operator\">=</span> scrapy<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p><em>Note: There is now a <a href=\"https://stackoverflow.com/a/5077350\">simple way</a> to have a dynamic schema without manually declaring all the fields.\nI will show how to use it in a next article</em></p>\n<p>You can open a new Scrapy shell to play around on any post page and figure out the selectors you are going to use.\nFor example:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">scrapy shell https://techcrunch.com/2017/05/01/awesomeness-is-launching-a-news-division-aimed-at-gen-z/</code></pre>\n<p>And once you have figured them out, you can write the scraper's missing method:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># spiders/techcrunch.py</span>\n\n<span class=\"token keyword\">from</span> tc_scraper<span class=\"token punctuation\">.</span>items <span class=\"token keyword\">import</span> BlogPost\n<span class=\"token keyword\">import</span> datetime\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TechcrunchSpider</span><span class=\"token punctuation\">(</span>scrapy<span class=\"token punctuation\">.</span>Spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token comment\"># ...</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">parse_post</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        item <span class=\"token operator\">=</span> BlogPost<span class=\"token punctuation\">(</span>\n            title<span class=\"token operator\">=</span>response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"h1::text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            author<span class=\"token operator\">=</span>response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".article__byline>a::text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            published_at<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>extract_post_date<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            content<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>extract_content<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            url<span class=\"token operator\">=</span>response<span class=\"token punctuation\">.</span>url\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">yield</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">extract_post_date</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        date_text <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\"meta[name='sailthru.date']::attr(content)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract_first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>strptime<span class=\"token punctuation\">(</span>date_text<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%Y-%m-%d %H:%M:%S\"</span> <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">extract_content</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        paragraphs_texts <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        p<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\" ::text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>extract<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".article-content>p\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n        paragraphs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> paragraphs_texts<span class=\"token punctuation\">]</span>\n        paragraphs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>re<span class=\"token punctuation\">.</span>subn<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> paragraphs<span class=\"token punctuation\">]</span>\n        paragraphs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>p <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> paragraphs <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\\n\\n\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>paragraphs<span class=\"token punctuation\">)</span></code></pre>\n<p>So what's going here?</p>\n<ul>\n<li>We instanciate a <code>BlogPost</code> item that we then yield, that's the Scrapy way.</li>\n<li>Most of the fields are straightforward, so we write their selectors inline.\nSome others are more complicated so we have extracted them to independent methods.</li>\n<li>The <code>published_at</code> field is a bit tricky because in the visible DOM there is no plain text datetime, only a vague 'X hours/days ago'.\nIf you inspect the DOM closely, you will find this meta <code>sailthru.date</code> that is easy to use and parse.</li>\n<li>The <code>extract_content</code> method is quite involved, but it's really not key to this article's objective.\nWe are basically joining the texts from the different paragraphs in a way that's human readable.\nBecause the content is actually HTML, we are losing some infos in the process, like the links and images.</li>\n</ul>\n<p>You can now run the spider with:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">scrapy crawl techcrunch <span class=\"token parameter variable\">-a</span> <span class=\"token assign-left variable\">limit_pages</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">-o</span> posts.json</code></pre>\n<p>and Scrapy will generate a nice <code>posts.json</code> file with all the scraped items. Yay!</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/jRoOTRr7Mi-1252.avif 1252w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/jRoOTRr7Mi-1252.webp 1252w\"><img alt=\"display posts.json contents\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/jRoOTRr7Mi-1252.png\" width=\"1252\" height=\"1190\"></picture></p>\n<h1 id=\"incremental-scraping\" tabindex=\"-1\"><a name=\"incremental\"></a>Incremental Scraping <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h1>\n<h2 id=\"store-items-in-mongodb\" tabindex=\"-1\">Store items in MongoDB <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>So in the last step we exported the items to a JSON file.\nFor long term storage and re-use, it's more convenient to use a database.\nWe will use MongoDB here, but you could use a regular SQL database too.\nI personally find it convenient on scraping projects to use a NoSQL database because of the frequent schema changes, especially as you initially iterate on the scraper.</p>\n<p>If you are on Mac OS X, these commands will install MongoDB server and start it as a service:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">brew <span class=\"token function\">install</span> mongodb\nbrew services start mongodb</code></pre>\n<p>We are going to create a Scrapy pipeline so that each yielded item will get saved to MongoDB.\nThis process is well documented in <a href=\"https://doc.scrapy.org/en/latest/topics/item-pipeline.html?highlight=mongo#write-items-to-mongodb\">Scrapy's docs</a>.</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># pipelines.py</span>\n\n<span class=\"token keyword\">import</span> pymongo\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MongoPipeline</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    collection_name <span class=\"token operator\">=</span> <span class=\"token string\">'tc_posts'</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> mongo_uri<span class=\"token punctuation\">,</span> mongo_db<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>mongo_uri <span class=\"token operator\">=</span> mongo_uri\n        self<span class=\"token punctuation\">.</span>mongo_db <span class=\"token operator\">=</span> mongo_db\n\n    <span class=\"token decorator annotation punctuation\">@classmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">from_crawler</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> crawler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> cls<span class=\"token punctuation\">(</span>\n            mongo_uri<span class=\"token operator\">=</span>crawler<span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'MONGO_URI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            mongo_db<span class=\"token operator\">=</span>crawler<span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'MONGO_DATABASE'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'tc_scraper'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">open_spider</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>client <span class=\"token operator\">=</span> pymongo<span class=\"token punctuation\">.</span>MongoClient<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>mongo_uri<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>db <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>mongo_db<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">close_spider</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">process_item</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>collection_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>insert_one<span class=\"token punctuation\">(</span><span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> item</code></pre>\n<p>and activate it in the settings:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># settings.py</span>\n\nITEM_PIPELINES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token string\">'tc_scraper.pipelines.MongoPipeline'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">300</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Last step is to install the new <code>pymongo</code> dependency:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">pip3 <span class=\"token function\">install</span> pymongo</code></pre>\n<p>You can now re-run the spider:</p>\n<pre><code>scrapy crawl techcrunch -a limit_pages=2\n</code></pre>\n<p>Feel free to open a mongo shell and check that the items were indeed inserted:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">mongo localhost/tc_scraper\n<span class=\"token operator\">></span> db.tc_posts.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">40</span>\n<span class=\"token operator\">></span> db.tc_posts.<span class=\"token function-name function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"5c09294a7fa9c70f84e43322\"</span><span class=\"token punctuation\">)</span>,\n\t<span class=\"token string\">\"url\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"https://techcrunch.com/2018/12/06/looker-looks-to-future-with-103m-investment-on-1-6b-valuation/\"</span>,\n\t<span class=\"token string\">\"author\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Ron Miller\"</span>,\n\n  <span class=\"token punctuation\">..</span>.</code></pre>\n<h2 id=\"update-existing-items\" tabindex=\"-1\">Update existing items <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>If you run the spider again, you will notice that you now have 80 items in your database.\nLet's update the Pipeline so that it does not insert a new post each time, but rather updates the existing one if it already exists.</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># pipelines.py</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">process_item</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>collection_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>find_one_and_update<span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">{</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span><span class=\"token string\">\"$set\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            upsert<span class=\"token operator\">=</span><span class=\"token boolean\">True</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> item</code></pre>\n<p>Here we are using the url as the key, because unfortunately there does not seem to be a more canonical ID in the DOM.\nIt should work as long as Techcrunch does not change their posts slugs or published dates often.</p>\n<p>You can drop all items and re-run the spider twice:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"db.tc_posts.drop();\"</span> <span class=\"token operator\">|</span> mongo localhost/tc_scraper\nscrapy crawl techcrunch <span class=\"token parameter variable\">-a</span> <span class=\"token assign-left variable\">limit_pages</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>\nscrapy crawl techcrunch <span class=\"token parameter variable\">-a</span> <span class=\"token assign-left variable\">limit_pages</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"db.tc_posts.count();\"</span> <span class=\"token operator\">|</span> mongo localhost/tc_scraper</code></pre>\n<p>You should now have only 40 items in the database.</p>\n<p><em>Note: If you are scared about running so many requests against Techcrunch.com, be aware that by default, Scrapy will use a <a href=\"https://doc.scrapy.org/en/latest/topics/downloader-middleware.html#module-scrapy.downloadermiddlewares.httpcache\">cache</a>.\nFor most requests, it will not re-run them every single time, but instead re-use the previous response</em></p>\n<h2 id=\"limit-crawls-to-new-items\" tabindex=\"-1\">Limit crawls to new items <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h2>\n<p>So far our solution is almost complete, but it will re-scrape all items every time you start it.\nIn this step, we will make sure that we don't re-scrape items uselessly, in order to have faster scraping sessions, and to limit our requests rate to the website.</p>\n<p>What we will do is to update the spider so that it prevents requests to items that were already scraped before and are in the database.</p>\n<p>First let's extract the MongoDB connection logic from the pipeline in order to re-use it in the spider:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># mongo_provider.py (new file)</span>\n\n<span class=\"token keyword\">import</span> pymongo\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MongoProvider</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    collection_name <span class=\"token operator\">=</span> <span class=\"token string\">'tc_posts'</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> uri<span class=\"token punctuation\">,</span> database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>mongo_uri <span class=\"token operator\">=</span> uri\n        self<span class=\"token punctuation\">.</span>mongo_db <span class=\"token operator\">=</span> database <span class=\"token keyword\">or</span> <span class=\"token string\">'tc_scraper'</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get_collection</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>client <span class=\"token operator\">=</span> pymongo<span class=\"token punctuation\">.</span>MongoClient<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>mongo_uri<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>mongo_db<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>collection_name<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">close_connection</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>and update the pipeline accordingly:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># pipelines.py</span>\n\n<span class=\"token keyword\">from</span> tc_scraper<span class=\"token punctuation\">.</span>mongo_provider <span class=\"token keyword\">import</span> MongoProvider\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MongoPipeline</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> settings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>mongo_provider <span class=\"token operator\">=</span> MongoProvider<span class=\"token punctuation\">(</span>\n            settings<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'MONGO_URI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            settings<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'MONGO_DATABASE'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n    <span class=\"token decorator annotation punctuation\">@classmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">from_crawler</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> crawler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> cls<span class=\"token punctuation\">(</span>crawler<span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">open_spider</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>collection <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>mongo_provider<span class=\"token punctuation\">.</span>get_collection<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">close_spider</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>mongo_provider<span class=\"token punctuation\">.</span>close_connection<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">process_item</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">,</span> spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>collection<span class=\"token punctuation\">.</span>find_one_and_update<span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">{</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span><span class=\"token string\">\"$set\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            upsert<span class=\"token operator\">=</span><span class=\"token boolean\">True</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> item</code></pre>\n<p><em>You can re-run the scraper at this checkpoint, nothing should have changed</em></p>\n<p>We can now update the spider so that it uses this mongo provider:</p>\n<pre class=\"language-py\" tabindex=\"0\"><code class=\"language-py\"><span class=\"token comment\"># spiders/techcrunch.py</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">from</span> tc_scraper<span class=\"token punctuation\">.</span>mongo_provider <span class=\"token keyword\">import</span> MongoProvider\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TechcrunchSpider</span><span class=\"token punctuation\">(</span>scrapy<span class=\"token punctuation\">.</span>Spider<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token decorator annotation punctuation\">@classmethod</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">from_crawler</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> crawler<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        kwargs<span class=\"token punctuation\">[</span><span class=\"token string\">'mongo_uri'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> crawler<span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"MONGO_URI\"</span><span class=\"token punctuation\">)</span>\n        kwargs<span class=\"token punctuation\">[</span><span class=\"token string\">'mongo_database'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> crawler<span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'MONGO_DATABASE'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>TechcrunchSpider<span class=\"token punctuation\">,</span> cls<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>from_crawler<span class=\"token punctuation\">(</span>crawler<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> limit_pages<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> mongo_uri<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> mongo_database<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        self<span class=\"token punctuation\">.</span>mongo_provider <span class=\"token operator\">=</span> MongoProvider<span class=\"token punctuation\">(</span>mongo_uri<span class=\"token punctuation\">,</span> mongo_database<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>collection <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>mongo_provider<span class=\"token punctuation\">.</span>get_collection<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        last_items <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>collection<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>sort<span class=\"token punctuation\">(</span><span class=\"token string\">\"published_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>limit<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>last_scraped_url <span class=\"token operator\">=</span> last_items<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> last_items<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> post <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">.</span>css<span class=\"token punctuation\">(</span><span class=\"token string\">\".post-block\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n            <span class=\"token keyword\">if</span> url <span class=\"token operator\">==</span> self<span class=\"token punctuation\">.</span>last_scraped_url<span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"reached last item scraped, breaking loop\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">yield</span> scrapy<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> callback<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>parse_post<span class=\"token punctuation\">)</span></code></pre>\n<p>Here is a quick breakdown of what we are doing here:</p>\n<ul>\n<li>In order to use the spider's settings that contain the mongo credentials, we need to do override this <code>from_crawler</code> method. It's quite verbose, and not very intuitive. I agree it's annoying.</li>\n<li>We then use these settings in the constructor to initialize a MongoDB connection thanks to our new <code>MongoProvider</code> class.</li>\n<li>We query Mongo for the last scraped item and store it's url.\nHere we are sorting the posts on the <code>published_at</code> descendingly, we made sure that this is consistent with Techcrunch's sorting, or else our algorithm would not work properly.</li>\n<li>In the parsing loop, we break and stop the scraping as soon as we reach a post with this url.\nWe do it by preventing yielding the request, and breaking from the loop.</li>\n</ul>\n<p>You can now perform a few tests, drop some of the last items from MongoDB and re-scrape, you will see that it only scrapes the missing items and stops. Success!</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">mongo localhost/tc_scraper\n<span class=\"token operator\">></span> last_item <span class=\"token operator\">=</span> db.tc_posts.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.sort<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>published_at: -1<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">></span> db.tc_posts.remove<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>_id: last_item<span class=\"token punctuation\">[</span><span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span>\nscrapy crawl techcrunch <span class=\"token parameter variable\">-a</span> <span class=\"token assign-left variable\">limit_pages</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></code></pre>\n<h1 id=\"conclusion\" tabindex=\"-1\">Conclusion <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-17-incremental-scraping-with-scrapy-and-mongo/\">#</a></h1>\n<p>We now have a scraper that will do the least amount of work possible on each new run. I hope you enjoyed this tutorial, and that this gave you new ideas for scraping projects!</p>\n<p>You can find the full code for this project here on GitHub: <a href=\"https://github.com/adipasquale/techcrunch-incremental-scrapy-spider-with-mongodb\">adipasquale/techcrunch-incremental-scrapy-spider-with-mongodb</a>.</p>\n<p>You can deploy your spider to <a href=\"https://scrapinghub.com/scrapy-cloud\">ScrapingHub cloud</a>, and schedule it to run daily on their servers.\nI'm not affiliated to them in any way, it's just an awesome product and their free plan already does a lot.\nBy the way, ScrapingHub is the main contributor to the fully open-source Scrapy project that we just used.</p>\n<p>To go further, you can implement a new <code>force_rescrape</code> argument, that will bypass our limit and force going through all the items again.\nThis could be useful if you update the <code>scrape_post</code> method, or if Techcrunch changes their DOM structure.</p>\n<p>Let me know if you use this technique in one of your projects!</p>\n<p><a href=\"https://news.ycombinator.com/item?id=18697956\">Discuss on Hacker News</a></p>\n",
			"date_published": "2018-12-17T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/",
			"title": "√âchelle des revenus en France",
			"content_html": "<ul>\n<li>√âdit√© le 25/12/2018 : <a href=\"https://github.com/adipasquale/blog.dipasquale.fr/commit/4b3ca1f50debad7aa1d71d3bcbe7c9dd1197ba51\"><em>remarques de @Paul_Puget sur les interpr√©tations</em></a></li>\n</ul>\n<p>Je me suis int√©ress√© √† tracer le graphique de l'√©chelle des revenus en France.\nL'id√©e est de pouvoir dire &quot;si vous vivez avec tant d'argent, vous √™tes mieux loti que X% des fran√ßais&quot;.</p>\n<p>C'est une statistique qui m'int√©resse particuli√®rement car elle est simple √† comprendre et permet de prendre du recul.\nEn l'occurence, cela peut permettre de mieux comprendre la contestation des &quot;gilets jaunes&quot;.</p>\n<h1 id=\"resultats\" tabindex=\"-1\">R√©sultats <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h1>\n<p>Avant toute chose, voici le r√©sultat de mes analyses :</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/IH67siQeIL-544.avif 544w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/IH67siQeIL-544.webp 544w\"><img alt=\"Revenus disponibles mensuels par unit√© de consommation\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/IH67siQeIL-544.png\" width=\"544\" height=\"495\"></picture></p>\n<p>De mani√®re simplificatrice, on peut lire ce graphique comme cela : <strong>&quot;si vous vivez avec 2500 euros par mois, vous √™tes mieux loti que 80% des fran√ßais&quot;</strong>.\n<em>Note : c'est un langage approximatif</em>.</p>\n<p>Pour √™tre pr√©cis, il faut bien pr√©ciser les termes employ√©s ici. Voici les d√©finitions de l'INSEE :</p>\n<blockquote>\n<p>Le <a href=\"https://www.insee.fr/fr/metadonnees/definition/c1458\">revenu disponible</a> d'un m√©nage comprend les revenus d'activit√© (nets des cotisations sociales), les revenus du patrimoine, les transferts en provenance d'autres m√©nages et les prestations sociales (y compris les pensions de retraite et les indemnit√©s de ch√¥mage), nets des imp√¥ts directs.</p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://www.insee.fr/fr/metadonnees/definition/c1802\">L'unit√© de consommation</a> est un Syst√®me de pond√©ration attribuant un coefficient √† chaque membre du m√©nage et permettant de comparer les niveaux de vie de m√©nages de tailles ou de compositions diff√©rentes. Avec cette pond√©ration, le nombre de personnes est ramen√© √† un nombre d'unit√©s de consommation (UC).\nPour comparer le niveau de vie des m√©nages, on ne peut s'en tenir √† la consommation par personne. En effet, les besoins d'un m√©nage ne s'accroissent pas en stricte proportion de sa taille. Lorsque plusieurs personnes vivent ensemble, il n'est pas n√©cessaire de multiplier tous les biens de consommation (en particulier, les biens de consommation durables) par le nombre de personnes pour garder le m√™me niveau de vie.\nAussi, pour comparer les niveaux de vie de m√©nages de taille ou de composition diff√©rente, on utilise une mesure du revenu corrig√© par unit√© de consommation √† l'aide d'une √©chelle d'√©quivalence. L'√©chelle actuellement la plus utilis√©e (dite de l'OCDE) retient la pond√©ration suivante :</p>\n<ul>\n<li>1 UC pour le premier adulte du m√©nage ;</li>\n<li>0,5 UC pour les autres personnes de 14 ans ou plus ;</li>\n<li>0,3 UC pour les enfants de moins de 14 ans.</li>\n</ul>\n</blockquote>\n<p>Donc, <em>en gros</em>, on parle ici de <strong>l'argent effectivement disponible dans chaque famille divis√© par le nombre de personnes de mani√®re d√©gressive</strong> (toutes sources confondues et apr√®s imp√¥ts).</p>\n<p>Les donn√©es utilis√©es proviennent de <a href=\"https://www.insee.fr/fr/statistiques/3560118\">ce dossier</a> de l'INSEE paru le 19/06/2018 analysant des donn√©es de 2015 (plus de d√©tails ci-dessous).</p>\n<p><em>Vous trouverez des graphiques √† d'autres √©chelles g√©ographiques √† la <a href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">fin de l'article</a>.</em></p>\n<h1 id=\"construction-de-l-analyse\" tabindex=\"-1\">Construction de l'analyse <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h1>\n<h2 id=\"recherche-des-donnees\" tabindex=\"-1\">Recherche des donn√©es <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h2>\n<p>Je me suis d'abord rendu sur <a href=\"https://www.data.gouv.fr/\">Data Gouv</a> et j'ai cherch√© avec des mots-cl√©s comme &quot;revenu m√©dian&quot;.\nJ'ai vite constat√© que les r√©sultats sont bien moins √©vidents que ce que j'esp√©rais, avec parfois un langage abscons.\nDe plus, les liens pointant vers des donn√©es de l'INSEE sont en partie cass√©s et redirigent vers la page d'accueil.</p>\n<p>Je me suis donc d√©plac√© sur le site de l'INSEE pour mes recherches.\nC'est tr√®s compliqu√© de comprendre o√π chercher les informations sur ce grand site au vocabulaire nouveau pour moi.\nIl y a pl√©thore de documents, de fiches, de donn√©es, regroup√©es sous des noms d'enqu√™tes tr√®s larges.\nTr√®s dur de savoir vers quoi chercher.\nJ'ai alors utilis√© mon joker √† un ami et <a href=\"https://twitter.com/AntoineAugusti\">@AntoineAugusti</a> m'a conseill√© de ne pas h√©siter √† √©crire √† l'INSEE pour qu'ils m'aiguillent.</p>\n<p>J'ai donc envoy√© un message depuis le formulaire de contact et j'ai effectivement re√ßu une r√©ponse tr√®s efficace sous quelques jours :</p>\n<blockquote>\n<p>Bonjour,</p>\n<p>Vous trouverez la ventilation des revenus disponibles par commune,sous la rubrique Statistique, en s√©lectionnant les crit√®res suivants :\nth√®mes : Revenus ‚Äì Pouvoir d'achat ‚Äì Consommation &gt; Revenus ‚Äì Niveaux de vie ‚Äì Pouvoir d'achat\ncat√©gories : Donn√©es &gt; Bases de donn√©es</p>\n<p>Les donn√©es sont accessibles sur la page <a href=\"https://www.insee.fr/fr/statistiques/3560118\">Structure et distribution des revenus, in√©galit√© des niveaux de vie en 2015</a>, puis dans le fichier &quot;Base niveau communes en 2015 - y compris arrondissements municipaux&quot;. Vous devez ensuite choisir le fichier &quot;FILO_DISP_COM.xls&quot;. La distribution par d√©cile se situe dans l'onglet &quot;ensemble&quot;.</p>\n</blockquote>\n<p>Cette r√©ponse a √©t√© quasiment parfaite pour mon usage et m'a d√©bloqu√© pour la suite !</p>\n<h2 id=\"retour-sur-la-recherche-de-donnees\" tabindex=\"-1\">Retour sur la recherche de donn√©es <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h2>\n<p>Mon sentiment sur cette recherche de donn√©es est partag√©.</p>\n<p>D'un c√¥t√© je suis √©bahi par la quantit√© et la qualit√© des donn√©es accessibles librement.\nEt aussi par la r√©ponse parfaite dans un temps raisonnable de l'INSEE √† une demande d'un particulier.</p>\n<p>D'un autre c√¥t√©, je trouve √ßa dommage d'avoir √† faire une demande de support pour une recherche de statistique qui me para√Æt relativement &quot;basique&quot;.\nL'exp√©rience aurait √©t√© bien meilleure si j'avais r√©ussi √† trouver moi-m√™me ce que je cherchais.\nC'est dommage que l'int√©gration de Data Gouv avec l'INSEE ne fonctionne pas, et je pense que beaucoup de choses pourraient √™tre faites pour am√©liorer la recherche et l'exploration au sein du site de l'INSEE. √áa m'a d'ailleurs donn√© l'id√©e d'ouvrir un site mirroir ... plus dans un autre post !</p>\n<p>Surtout, je pense que je n'aurais jamais envoy√© un message de support √† l'INSEE si mon ami qui conna√Æt le milieu ne me l'avait sugg√©r√©.\nJe ne me serais pas senti l√©gitime, et/ou je n'aurais jamais pens√© recevoir une r√©ponse aussi efficace rapidement.</p>\n<h2 id=\"construction-du-graphique\" tabindex=\"-1\">Construction du graphique <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h2>\n<p>√áa a √©t√© l'occasion pour moi de re-d√©couvrir pandas, que je n'avais pas utilis√© depuis longtemps.\nJ'ai aussi pu utiliser Jupyter, le successeur de iPython Notebook, que je ne connaissais pas.</p>\n<p>La bonne surprise a √©t√© de voir que l'installation de cet environnement complet de stats (numpy, pandas, Jupyter ...) sur mon OS X s'est fait avec 3 commandes <code>pip3 install</code>, sans aucun probl√®me. J'ai des souvenirs de cauchemards de d√©pendances ininstallables il y a quelques ann√©es.</p>\n<p>Dans un premier temps, j'ai travaill√© sur le fichier indiqu√© par le support de l'INSEE qui contient les donn√©es √† l'√©chelle communale. J'ai voulu faire une moyenne des d√©ciles, avant de me rendre compte que c'√©tait probablement une erreur statistique. J'ai alors pens√© pond√©rer les moyennes avec la population de chaque commune. Intuitivement, impossible de me d√©cider sur la validit√© d'une telle op√©ration : <strong>est-ce qu'on peut d√©couper un ensemble en sous-ensembles, calculer les d√©ciles sur ces sous-ensembles, et en faire la moyenne pond√©r√©e pour retomber sur les d√©ciles de l'ensemble global ?</strong>. Je n'ai pas trouv√© la r√©ponse sur internet, donc j'ai fait des simulations dans un autre notebook pour me faire une id√©e. Et √ßa n'a pas l'air valide, on ne retombe pas sur les m√™mes valeurs ! vous pouvez jouer avec ce notebook de tests <a href=\"https://mybinder.org/v2/gh/adipasquale/france-income-disparities-2015/master?filepath=check%20weighted%20percentiles.ipynb\">sur Binder</a> si √ßa vous int√©resse.</p>\n<p>J'ai alors sorti le nez du guidon, pour me rendre compte qu'il y avait un jeu de donn√©es voisin √† √©chelle plus haute, notamment √† l'√©chelle nationale <code>FILO_DISP_METROPOLE.xls</code>. C'est beaucoup plus facile comme √ßa !</p>\n<p>Le reste est un &quot;jeu d'enfants&quot; qui m'a quand m√™me pris quelques heures pour me rappeler comment manipuler les DataFrame et le plotting.</p>\n<p>Vous pouvez trouver le code source du Notebook Jupyter sur <a href=\"https://github.com/adipasquale/france-income-disparities-2015\">GitHub</a>, et aussi en lancer une version interactive avec Binder <a href=\"https://mybinder.org/v2/gh/adipasquale/france-income-disparities-2015/master?filepath=revenus%20disponibles%20france%20metropolitaine%20-%20deciles.ipynb\">en suivant ce lien</a>.</p>\n<h1 id=\"par-region-et-par-commune\" tabindex=\"-1\"><a name=\"regions\"></a>Par r√©gion et par commune <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h1>\n<p>Dans les donn√©es disponibles, on a le d√©tail √† diff√©rentes √©chelles, dont l'√©chelle r√©gionale et l'√©chelle communale.</p>\n<h2 id=\"par-region\" tabindex=\"-1\">Par r√©gion <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h2>\n<p>Voici ce que √ßa donne r√©gion par r√©gion :</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/u42YsvgEBU-923.avif 923w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/u42YsvgEBU-923.webp 923w\"><img alt=\"Revenus disponibles mensuels par unit√© de consommation par r√©gion\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/u42YsvgEBU-923.png\" width=\"923\" height=\"710\"></picture></p>\n<p>C'est un peu illisible, j'ai isol√© de mani√®re un peu arbitraire les extr√™mes  :</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/8a3U-7Vqj7-644.avif 644w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/8a3U-7Vqj7-644.webp 644w\"><img alt=\"Revenus disponibles mensuels par unit√© de consommation par r√©gion, seulement les extr√™mes\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/8a3U-7Vqj7-644.png\" width=\"644\" height=\"601\"></picture></p>\n<p>On voit des diff√©rences de r√©partition importantes et surtout des in√©galit√©s de niveaux de vie tr√®s marqu√©es.</p>\n<h2 id=\"au-sein-de-paris\" tabindex=\"-1\">Au sein de Paris <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h2>\n<p>Ensuite, j'ai regard√© √† l'√©chelle des communes. On ne peut √©videmment pas envisager de tracer le graphique pour les 36000 communes fran√ßaises et quelques, il faut donc faire des choix.</p>\n<p>J'ai d'abord regard√© les diff√©rences entre les diff√©rents arrondissements de Paris. Avec 20 arrondissements, le graphique est illisible, le voici avec les 4 arrondissements ayant respectivement les 2 taux d'in√©galit√©s les plus forts et les plus faibles (mesur√©s par <a href=\"https://www.insee.fr/fr/metadonnees/definition/c1551\">l'indice de Gini</a>).</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/brHZJXQAmW-554.avif 554w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/brHZJXQAmW-554.webp 554w\"><img alt=\"Revenus disponibles mensuels par unit√© de consommation par r√©gion\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/brHZJXQAmW-554.png\" width=\"554\" height=\"492\"></picture></p>\n<p>Et non, ce n'est pas le 16√®me qui a le plus haut taux d'in√©galit√©, mais bien le 7√®me ! (le 16√®me est 3√®me). Les diff√©rences sont extr√®mement marqu√©es avec les deux arrondissements √† l'extr√™me oppos√©. On note que le 1er d√©cile est quasiment identique : les m√©nages ayant le moins de revenu en ont √† peu pr√®s autant dans le 7√®me que dans le 20√®me. Et on voit aussi de mani√®re flagrante que <strong>les m√©nages ayant le plus de revenus en ont environ 3 fois plus √† Paris 7√®me qu'√† Paris 20√®me</strong>.</p>\n<p><strong>Mise √† jour</strong>: <a href=\"https://twitter.com/Paul_Puget\">@Paul_Puget</a> m'a fait remarquer que mon interpr√©tation est erron√©e. On peut effectivement lire que le dernier d√©cile est environ trois fois plus √©lev√©. On ne peut cependant pas en tirer de conclusions sur les revenus moyens de ces 10% de gens les plus riches. Il n'est pas impossible que le revenu moyen dans ce dernier d√©cile soit plus √©lev√© dans le 20√®me que dans le 7√®me, cf <a href=\"https://imgur.com/a/adr4V8Y\">ce petit sch√©ma √† la main</a>.</p>\n<h2 id=\"par-ville\" tabindex=\"-1\">Par ville <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h2>\n<p>Enfin j'ai regard√© les communes √† l'√©chelle nationale. J'ai filtr√© les donn√©es pour voir les grandes villes uniquement, en utilisant cette r√®gle : &quot;nombre de personnes dans les m√©nages fiscaux sup√©rieur √† 100000&quot;.</p>\n<p>Voici un graphique repr√©sentant 5 villes choisies arbitrairement pour repr√©senter la &quot;palette&quot; de r√©partition des revenus : Paris (taux d'in√©galit√© le plus fort), Marseille, Brest (taux d'in√©galit√© le plus faible), Toulouse et Lyon.</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/FtMHLDqUnQ-545.avif 545w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/FtMHLDqUnQ-545.webp 545w\"><img alt=\"Revenus disponibles mensuels par unit√© de consommation par communes\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/FtMHLDqUnQ-545.png\" width=\"545\" height=\"492\"></picture></p>\n<p>L√† encore, on voit un sch√©ma similaire, c'est-√†-dire que les √©carts se produisent principalement dans les d√©ciles les plus hauts. Je pense que l'on peut lire cela comme √ßa : <strong>&quot;Les √©carts de r√©partitions des richesses dans les grandes villes fran√ßaises se concentrent dans les classes les plus ais√©es&quot;.</strong></p>\n<p><strong>Mise √† jour</strong>: Ici encore, <a href=\"https://twitter.com/Paul_Puget\">@Paul_Puget</a> a relev√© que cette interpr√©tation est un peu h√¢tive. Le graphique permet de voir l‚Äô√©volution selon les diff√©rents d√©ciles des √©carts absolus de revenus entre les diff√©rentes villes. Mais on ne peut pas vraiment y lire l‚Äô√©volution des rapports entre ces revenus de diff√©rentes villes. Peut-√™tre que le rapport entre les revenus disponibles √† Marseille et √† Paris et le m√™me pour le premier d√©cile et le dernier, par exemple 0,8. On peut difficilement le lire sur ce graphique en tout cas.</p>\n<h1 id=\"conclusion\" tabindex=\"-1\">Conclusion <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-07-echelle-des-revenus-en-france/\">#</a></h1>\n<p>J'esp√®re que comme moi vous avez appris des choses, et surtout que √ßa vous a donn√© envie d'en savoir plus. Je vous invite √† visiter le site de <a href=\"https://www.insee.fr/\">l'INSEE</a> et celui de <a href=\"https://www.data.gouv.fr/\">Data Gouv</a> pour chercher des donn√©es int√©ressantes. J'ai plein d'id√©es pour d'autres analyses, notamment avec l'indice de Gini, si √ßa vous int√©resse suivez-moi sur Twitter : <a href=\"https://twitter.com/hypertextadrien\">@hypertextadrien</a>.</p>\n<p>Et surtout n'h√©sitez pas √† me contacter si vous avez des questions, ou si vous avez rep√©r√© des erreurs dans les manipulations de donn√©es ou dans mes interpr√©tations !</p>\n",
			"date_published": "2018-12-07T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/",
			"title": "Leave Gmail in 10 steps",
			"content_html": "<ul>\n<li>updated on 25/12/2018 : <a href=\"https://github.com/adipasquale/blog.dipasquale.fr/commit/93819a06f0551f01ec4304ba76c83705f38fbb36\"><em>added link to Fastmail's post about AABill</em></a></li>\n</ul>\n<blockquote>\n<p>In exchange for free mails, would you let your postman open your letters, read them, and insert ads related to their contents?</p>\n</blockquote>\n<p>This is a common analogy for Gmail's model. The privacy implications of using Gmail actually go much farther than that, because Gmail is not only your postman (with Gmail), it also owns your car ( your web browser), your address book (with Search), your TV (with YouTube), it's a great land owner (with AdSense)‚Ä¶ And there are many reasons not to trust Google, <a href=\"http://precursorblog.com/?q=content/googles-top-35-privacy-scandals\">especially with your privacy</a>.</p>\n<p><strong>Important edit</strong>: As many commenters pointed out, this analogy is actually not correct anymore, as <a href=\"https://techcentral.co.za/google-will-stop-reading-e-mail/75215/\">Google stopped reading your emails for ad-personalization</a> in 2017, sorry I missed that news. However, they <a href=\"https://theoutline.com/post/4524/remember-when-google-said-it-would-stop-reading-your-email\">do still read</a> them in order to &quot;customize search results, better detect spam and malware&quot;.</p>\n<p>Migrating away from any email service, like changing addresses in real world life, is always going to be tedious. I did not find that Gmail makes it particularly harder, but I hope this guide can help you.</p>\n<p>Disclaimer : This guide will not help you find alternatives for the Gmail-specific features, like labels, snoozing, bundles, suggested replies and so on.</p>\n<h2 id=\"step-1-get-a-new-mail-address-and-provider\" tabindex=\"-1\">Step 1 : Get a new mail address and provider <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>First, I strongly suggest you buy a domain name, so that you really own your mail address, and don't depend on any service. You can purchase one at <a href=\"https://www.gandi.net/\">Gandi</a>.</p>\n<p>From there on, you could use Gandi's mail servers, but I recommend you use <a href=\"https://fastmail.com/\">Fastmail's</a>. It's not free, but it will be much simpler to setup, faster, they provide push notifications for mobile, their spam filter is better, their web interface is better, and it's the most popular privacy-respecting service.</p>\n<p><strong>Edit</strong>: I am not affiliated to Fastmail in any way, and I do not want this article to look like an ad!\nAlso, as <a href=\"https://news.ycombinator.com/item?id=18633216\">HN commenters</a> and <a href=\"https://twitter.com/mediafinger/status/1071325185364672513\">@mediafinger</a> pointed out, Fastmail is an Australian company, where they just passed <a href=\"https://www.nytimes.com/2018/12/06/world/australia/encryption-bill-nauru.html\">a new bill</a>, which is concerning for privacy.\nFastmail stated <a href=\"https://fastmail.blog/2018/12/21/advocating-for-privacy-aabill-australia/\">in a blog post</a>  that this law does not impact them though.\nHave a look at other privacy-caring providers like <a href=\"https://mailbox.org/\">mailbox.org</a>, <a href=\"https://runbox.com/\">runbox.com</a>,<a href=\"https://posteo.de/\">posteo.de</a> and <a href=\"https://www.startmail.com/\">startmail.com</a>, they may very well be cheaper too.</p>\n<p><a href=\"https://www.fastmail.com/signup/\">Signing up with Fastmail</a> is very simple. If you bought a domain name, you can use their <a href=\"https://www.fastmail.com/help/receive/domains-setup-nsmx.html\">easy-setup option</a> where you use their name servers and they do all the hardlifting. You will still be able to add custom DNS entries later if you want to, for your personal website or blog. If you did not buy a domain name, you can also create a mail address ending with one of theirs : sent.com, fastmail.com‚Ä¶</p>\n<h2 id=\"step-2-clients-setup-and-update-round\" tabindex=\"-1\">Step 2 : Clients setup and update round <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>By client, here, I mean the applications that you use to read and write mail. Gmail has both a web client (a website) and mobile apps.</p>\n<p>There are lots of options for mail clients. Fastmail comes with a web client too, that is quite different from Gmail and less featureful, but it works well.</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/c2DoVPlMNU-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/c2DoVPlMNU-800.webp 800w\"><img alt=\"Fastmail's web interface\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/c2DoVPlMNU-800.png\" width=\"800\" height=\"540\"></picture></p>\n<p>Windows 10+, OS X and iOS come with decent native mail clients, I suggest you start with these. Android on the other hand now has Gmail as the default mail app, so you will have to try a new one. Fastmail has some <a href=\"https://www.fastmail.com/help/clients/applist.html\">great guides</a> for setupping these mail clients and it's sometimes as easy as scanning a personalized QR-Code.</p>\n<p>You can try sending a mail from your Gmail to your new mail and check that you are receiving it on all the devices that you care about. Once you are up and running with your new address, it's the perfect moment to try and update your mail address on the services you use daily (Social networks, Github, Amazon‚Ä¶). If you use a password manager it can help you identify the services you have forgot.</p>\n<h2 id=\"step-3-delete-useless-mails-from-gmail\" tabindex=\"-1\">Step 3 : Delete useless mails from Gmail <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>I strongly suggest that you take the time to clean up the clutter you have accumulated in your Gmail before anything. Here are some reasons to do so :</p>\n<ul>\n<li>migrating your mails will be faster</li>\n<li>you will not reach the storage limit on your new provider as fast</li>\n<li>it feels good :)</li>\n</ul>\n<p>It‚Äôs important to do it before migrating or else you‚Äôll be cleaning up 2 mailboxes (I did and lost a lot of time).</p>\n<p>Look at your space usage for mail on <a href=\"https://drive.Google.com/settings/storage\">this Google page</a>, by clicking on the details link. If it looks reasonable, you may skip this step.</p>\n<p>The first way to find useless mails is easy : look for mails with big attachments. You can use this Gmail search query <code>size:5MB</code> or any other threshold.</p>\n<p>The second way is trickier : you want to look for redundant, similar mails : facebook notifications, Google alerts, GitHub comments‚Ä¶ This can represent a very high number of mail and thus of space. Surprisingly I could not find a good tool to identify these mails. It cannot be done with Google queries. There is a plug-in in Thunderbird but it was very buggy for me and opening Thunderbird feels like travelling back to the 90s üò¢ The best way I found was to use python's mbox files support out of the box. I published a small script called <a href=\"https://github.com/adipasquale/mbox-sender-frequency\">mbox-sender-frequency</a>. It lists all addresses that have sent over 100 mails to you. You can then filter and drop them on Gmail.</p>\n<p><img src=\"https://i.imgur.com/isCPq3N.png\" alt=\"example usage of mbox-sender-frequency\"></p>\n<h2 id=\"step-4-export-your-data-from-google-and-archive-it\" tabindex=\"-1\">Step 4 : Export your data from Google and archive it <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>I have to hand it out to Google they make it quite easy to export your mails. Head to <a href=\"https://takeout.Google.com\">Google Takeout</a> and select mails. You‚Äôll need to have it locally so I suggest you take the download option. They‚Äôll mail you a link once they have gathered it all in a nice mbox file.</p>\n<p>I suggest you store this mbox archive somewhere safe, ie. not a hard drive :) I went with S3 Cloud Storage. You want to keep this file for a long while, maybe a year or so.</p>\n<h2 id=\"step-5-migrate-all-mails\" tabindex=\"-1\">Step 5 : Migrate all mails <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>Important : <strong>do not yet use Fastmail's Identities &amp; Fetch feature</strong>. It would be slower and less reliable at this point.</p>\n<p>Fastmail has a very nice Email import tool, that will fetch mail from Google's IMAP servers and import them to your new account. To use it, follow <a href=\"https://www.fastmail.com/help/receive/migratemail.html\">these very clear instructions by Fastmail</a>. Do use the 'no duplicate' checkbox, because mails with labels would be fetched multiple times otherwise.</p>\n<p>This step can take a while, a whole night for me. Once it's done, do give a look at the logs as you do not want to miss anything. You should also have a look at your mails, browsing to the oldest is a good idea.</p>\n<h2 id=\"step-6-delete-all-migrated-mails-from-gmail\" tabindex=\"-1\">Step 6 : Delete all migrated mails from Gmail <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>Once you are confident you have everything on your new account and have backed up the archive file, you may go back to  and delete all your mails. That is a very thrilling step!</p>\n<p>Note : Because the migration process takes a while, you may have received mail to your Gmail account between steps 5 and 6, and that mail was not migrated to your new account. In that case, you may want to limit the mails you are deleting using a search filter.</p>\n<h2 id=\"step-7-synchronize-future-gmail-mails-to-fastmail\" tabindex=\"-1\">Step 7 : Synchronize future Gmail mails to Fastmail <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>You can now setup the <a href=\"https://www.fastmail.com/help/receive/fetchotheremail.html\">Identities &amp; Fetch</a> feature with your Gmail account. All the mails received during the migration, and the future incoming ones to Gmail will now be synchronized to your new account. You can also setup a sender alias to write mails with your old Gmail address, if necessary.</p>\n<p>You are ready to remove the Gmail apps from all your devices, you are almost free!</p>\n<h2 id=\"step-8-monitor-mails-still-sent-to-your-gmail-account\" tabindex=\"-1\">Step 8 : Monitor mails still sent to your Gmail account <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>The idea is to reduce more and more the mails you receive to your Gmail address. To do so, you can search <code>to:youroldaddress@.com</code> on Fastmail web interface, and save it. Then, go check out the results regularly and try and make sure that you will not receive similar mails in the future.</p>\n<p>If it‚Äôs an automated mail from a service you use, go update your address (or unsubscribe !). If it‚Äôs from a person, then let them know you have changed your mail address.</p>\n<h2 id=\"step-9-actually-close-your-gmail-account\" tabindex=\"-1\">Step 9 : Actually close your Gmail account <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>Once you are not receiving any more mail to your Gmail address (or barely) you can take the big step and close your Gmail account.</p>\n<p>You can follow <a href=\"https://support.Google.com/accounts/answer/61177\">Google's guide</a> to do so. Some nice facts are that your address may never be used by anyone in the future, and that your Google Account will not be deleted in the same time.</p>\n<p>I'm a cheater : I have not actually gone through this step yet. I think I will wait at least one year in order to be sure I'm not receiving any import mail to my Gmail address.</p>\n<h2 id=\"step-10-go-the-extra-mile\" tabindex=\"-1\">Step 10 : Go the extra mile <a class=\"header-anchor\" href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2018-12-02-leave-gmail-in-10-steps/\">#</a></h2>\n<p>While you are at it you may want to try and replace other Google services.</p>\n<p>Natural followers are the Calendar and Contacts apps. These are two pieces of sensitive data that you can very easily export from Google and import into your new Fastmail account. Then you can again replace the Google Calendar and Google Contacts apps with alternatives. The Apple ones have proven far good enough for my usage.</p>\n<p>If you want to go further, you can check the <a href=\"https://nomoregoogle.com/\">No More Google list</a> to find popular alternatives to Google Services.</p>\n<p><picture><source type=\"image/avif\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/F9MUgSIHUm-429.avif 429w\"><source type=\"image/webp\" srcset=\"https://www.dipasquale.fr/eleventy-base-blog/img/F9MUgSIHUm-429.webp 429w\"><img alt=\"no more google\" loading=\"lazy\" decoding=\"async\" src=\"https://www.dipasquale.fr/eleventy-base-blog/img/F9MUgSIHUm-429.png\" width=\"429\" height=\"77\"></picture></p>\n<p>I was very surprised how easy it was to stop using Google Chrome. The new Firefox is fast, almost bug free, and has all the web development tools I need. I was also using Chrome on my iPhone but I like Safari more now that I have switched. The transition was smooth and intuitive and it‚Äôs obviously better integrated with iOS.</p>\n<p>The only Google apps I really could not stop using are Maps and Docs. They both have features I could not find anywhere else and which I don't want to stop using altogether.</p>\n<p>I hope this helps, let me know if you switch!</p>\n<p><em>You can comment this article on <a href=\"https://news.ycombinator.com/item?id=18627509\">Hacker News</a></em></p>\n",
			"date_published": "2018-12-02T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2017-06-26-designing-state-machines/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2017-06-26-designing-state-machines/",
			"title": "Designing state machines",
			"content_html": "<p>This is a post I wrote while I was working at Drivy, as we were tweaking the models state machines. You can find it here : <a href=\"https://drivy.engineering/designing-state-machines/\">https://drivy.engineering/designing-state-machines/</a>.</p>\n<p>As a TLDR; this post suggests :</p>\n<ul>\n<li>Keep it as simple as possible</li>\n<li>Talk with all your team-mates to understand the vocabulary</li>\n<li>Do not over-anticipate your future needs</li>\n<li>Store all relevant infos including the transitions from state to state</li>\n</ul>\n<p>I initially presented these tips as a lightning talk for the <a href=\"https://www.meetup.com/fr-FR/parisrb/events/rqtgrlyvkbhb/\">ParisRb meetup on 05/07/2016</a>. You can find my slides here : <a href=\"https://adipasquale.github.io/state-machines-lightning-talk\">https://adipasquale.github.io/state-machines-lightning-talk</a></p>\n",
			"date_published": "2017-06-26T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2017-03-13-taskqueues-tips/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2017-03-13-taskqueues-tips/",
			"title": "Taskqueues tips",
			"content_html": "<p>I wrote a post listing a few tips to write a taskqueue while I was working at Drivy. You can find it here : <a href=\"https://drivy.engineering/taskqueues-tips/\">https://drivy.engineering/taskqueues-tips/</a>.</p>\n<p>As a TLDR; this post suggests :</p>\n<ul>\n<li>Writing re-entrant idempotent tasks that require the least number of arguments possible</li>\n<li>Avoid class-level calls</li>\n<li>Avoid mutable instance variables</li>\n<li>Specialize your workers for more efficiency</li>\n<li>Queues should be designed by speed and urgency, not semantically</li>\n<li>Read carefully your message broker's doc (Redis, RabbitMQ ...) and monitor it</li>\n<li>Also monitor your queues SLAs, your worker's memory and exceptions, and your CRON</li>\n<li>Check your DB connection pool</li>\n</ul>\n<p>I also spoke about this in a meetup talk, you can find the slides here : <a href=\"https://adipasquale.github.io/taskqueues-slides-2015\">https://adipasquale.github.io/taskqueues-slides-2015</a></p>\n",
			"date_published": "2017-03-13T00:00:00Z"
		}
		,
		{
			"id": "https://www.dipasquale.fr/eleventy-base-blog/blog/2013-02-20-capistrano-environment-variables/",
			"url": "https://www.dipasquale.fr/eleventy-base-blog/blog/2013-02-20-capistrano-environment-variables/",
			"title": "Capsitrano Environment variables",
			"content_html": "<p>This is the story of an epic fight. Me (regular guy) vs the server (Rails 3, deployed via Capistrano to a Passenger ‚Äì Nginx hosted Ubuntu server, using Mandrill transactional mail service). not a fair fight.</p>\n<p>If you already know the deal (or just don‚Äôt want to hear me whine) jump <a href=\"https://www.dipasquale.fr/eleventy-base-blog/blog/2013-02-20-capistrano-environment-variables/\">there</a> for the Capistrano task that‚Äôll magically expand your environment variables in the config.</p>\n<p>First if you follow Mandrill‚Äôs <a href=\"https://help.mandrill.com/entries/21738467-Using-Mandrill-s-SMTP-integration-with-Web-Frameworks\">guide</a> (spoiler: you should not), this is what you‚Äôd set up in your config/production.rb :</p>\n<pre class=\"language-ruby\" tabindex=\"0\"><code class=\"language-ruby\">config<span class=\"token punctuation\">.</span>action_mailer<span class=\"token punctuation\">.</span>smtp_settings <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token symbol\">:address</span>   <span class=\"token operator\">=></span> <span class=\"token string-literal\"><span class=\"token string\">\"smtp.mandrillapp.com\"</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token symbol\">:port</span>      <span class=\"token operator\">=></span> <span class=\"token number\">587</span><span class=\"token punctuation\">,</span>\n  <span class=\"token symbol\">:enable_starttls_auto</span> <span class=\"token operator\">=></span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token symbol\">:user_name</span> <span class=\"token operator\">=></span> <span class=\"token string-literal\"><span class=\"token string\">\"MANDRILL_USERNAME\"</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token symbol\">:password</span>  <span class=\"token operator\">=></span> <span class=\"token string-literal\"><span class=\"token string\">\"MANDRILL_API_KEY\"</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token symbol\">:authentication</span> <span class=\"token operator\">=></span> <span class=\"token string-literal\"><span class=\"token string\">'login'</span></span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>I know your extra picky security cerebrum already picked up the issue with this. hardcoding the username and password in your config file cannot be a good idea, especially if you‚Äôre sharing your code with many people. A better way is to use environment variables.</p>\n<pre class=\"language-ruby\" tabindex=\"0\"><code class=\"language-ruby\"><span class=\"token symbol\">:user_name</span> <span class=\"token operator\">=></span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"MANDRILL_USERNAME\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token symbol\">:password</span>  <span class=\"token operator\">=></span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"MANDRILL_API_KEY\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></code></pre>\n<p>you then have to set these variables on your prod server, in /etc/profile for example :</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">MANDRILL_USERNAME</span><span class=\"token operator\">=</span>foo\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">MANDRILL_API_KEY</span><span class=\"token operator\">=</span>bar</code></pre>\n<p>Now, it can‚Äôt be that simple, right ? right.\nWhereas my mails were not sent, the logger did not give me any errors, so first things first, I figured I‚Äôd turn the failed mail deliveries warning on in config/production.rb :</p>\n<pre class=\"language-ruby\" tabindex=\"0\"><code class=\"language-ruby\">config<span class=\"token punctuation\">.</span>action_mailer<span class=\"token punctuation\">.</span>raise_delivery_errors <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></code></pre>\n<p>if you‚Äôre doing this live on your production server (and you should) you have to restart Passenger :</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\"><span class=\"token function\">touch</span> tmp/restart.txt</code></pre>\n<p>And I could now see a beautiful <code>Net::SMTPServerBusy, Relay access denied error</code>. First I believed it came from a blocked 587 port, got postfix to work, and everything worked fin, hmmm. Heck, it even worked when I launched a thin server on the prod !\nThis <a href=\"https://stackoverflow.com/questions/13963795/rails-mailer-netsmtpserverbusy\">Stack Overflow</a> entry showed me the way to the problem : Passenger doesn‚Äôt set your environment variables when you fire it up.</p>\n<p>One solution is to load your variables in the wrapper around Ruby interpreter that Passenger uses (more info on this <a href=\"https://blog.rayapps.com/2008/05/21/using-mod_rails-with-rails-applications-on-oracle/\">here</a>). I don‚Äôt like this idea much, it feels very hacky, what‚Äôll happen when I‚Äôll upgrade my Ruby for example ?</p>\n<p>My solution is to expand the variables in your config file during the deploy (meaning replacing ENV[‚ÄúMANDRILL_USERNAME‚Äù] with the actuall username value, copied from the environment variable).\nThis amazing <a href=\"https://stackoverflow.com/questions/1609423/using-sed-to-expand-environment-variables-inside-files#answer-1610500\">SO answer</a> helped a lot, I tweaked it a bit to fit a Capistrano deploy task. It will expand ANY of your environment variables, how great is that ?!</p>\n<p>Warning: this is some mad-ass syntax, even the built-in highlighter can‚Äôt figure it out. There‚Äôs a LOT of escaping, between sed syntax and ruby‚Äôs ‚Ä¶</p>\n<pre class=\"language-ruby\" tabindex=\"0\"><code class=\"language-ruby\">desc <span class=\"token string-literal\"><span class=\"token string\">\"Replace environment variables with hardcoded values in config file\"</span></span>\ntask <span class=\"token symbol\">:replace_env_vars</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">roles</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:app</span> <span class=\"token keyword\">do</span>\n  run <span class=\"token string-literal\"><span class=\"token string\">\"mv </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">release_path</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/config/environments/production.rb </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">release_path</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/config/environments/production.before_sed.rb\"</span></span>\n  run <span class=\"token string-literal\"><span class=\"token string\">'env | sed \\'s/[\\%]/\\\\&amp;amp;/g;s/\\([^=]*\\)=\\(.*\\)/s%ENV\\\\\\[\\\\\\\"\\1\\\\\\\"\\\\\\]%\\\"\\2\\\"%/\\' > '</span></span> <span class=\"token operator\">+</span> <span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">release_path</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/script/expand_env_vars.sed.script\"</span></span>\n  run <span class=\"token string-literal\"><span class=\"token string\">\"cat </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">release_path</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/config/environments/production.before_sed.rb | sed -f </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">release_path</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/script/expand_env_vars.sed.script > </span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">release_path</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/config/environments/production.rb\"</span></span>\n<span class=\"token keyword\">end</span>\n\nafter <span class=\"token string-literal\"><span class=\"token string\">\"deploy:update_code\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">\"deploy:replace_env_vars\"</span></span></code></pre>\n<p>Note : this will only replace strings that use double quotes like <code>ENV[‚ÄúJESSICA_ALBA_PHONE_NUMBER‚Äù]</code> (I gather you wouldn‚Äôt share that piece of intel with any other developer)</p>\n<p>Hey, lucky you ! There‚Äôs a last step, and it‚Äôs so easy it feels good. By default, the SSH session opened by Capistrano doesn‚Äôt execute your init scripts (~/.profile, ~/.bashrc, not even /etc/profile/). These are <a href=\"https://pretheory.wordpress.com/2008/02/12/capistrano-path-and-environment-variable-issues/\">DanM instructions</a> (cheers !) to load them up. Create <code>~/.ssh/environment</code> and reput the export instructions, or you can even load your whole <code>/etc/profile</code> file, even though I have no idea what the security implications are. just don‚Äôt if you are ignorant like me.\nTell your SSH server to load this file : add this line in <code>/etc/ssh/sshd_config</code> :</p>\n<pre><code>PermitUserEnvironment yes\n</code></pre>\n<p>and restart it with</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> /etc/init.d/ssh restart</code></pre>\n<p>That should make your day. If it does not, feel free to let out your sorrow in the comments.</p>\n",
			"date_published": "2013-02-20T00:00:00Z"
		}
		
	]
}
